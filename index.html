<script>

const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrKaaK1w5UbLKNRBJ9qwr45HupRSFB2E6ZqfS53lDHihZBzAzOhcI9ZYRQnrLhkHPndA/exec";

let questions = [];
let current = 0;
let startTime;
let correctAnswer;
let blockSubmit = false;

function generateBlock(type){
  let block = [];
  for(let i=1; i<=9; i++){
    if(type === "add") block.push({q: `${i} + ${i}`, a: i+i});
    if(type === "x2") block.push({q: `${i} x 2`, a: i*2});
    if(type === "square") block.push({q: `${i} x ${i}`, a: i*i});
    if(type === "x5") block.push({q: `${i} x 5`, a: i*5});
  }
  return block;
}

// ðŸ” FunÃ§Ã£o para embaralhar (Fisher-Yates)
function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    let j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

function start(mode){

  questions = [];

  if(mode === "add") questions = generateBlock("add");
  if(mode === "x2") questions = generateBlock("x2");
  if(mode === "square") questions = generateBlock("square");
  if(mode === "x5") questions = generateBlock("x5");
  if(mode === "add_x2") questions = [...generateBlock("add"), ...generateBlock("x2")];
  if(mode === "add_x2_square") questions = [...generateBlock("add"), ...generateBlock("x2"), ...generateBlock("square")];
  if(mode === "all") questions = [...generateBlock("add"), ...generateBlock("x2"), ...generateBlock("square"), ...generateBlock("x5")];

  // ðŸ” ALEATORIZA ORDEM
  questions = shuffle(questions);

  current = 0;

  document.getElementById("menu").classList.add("hidden");
  document.getElementById("game").classList.remove("hidden");
  document.getElementById("final").classList.add("hidden");

  nextQuestion();
}

function nextQuestion(){

  if(current >= questions.length){
    finish();
    return;
  }

  blockSubmit = false;
  document.getElementById("submitBtn").style.display = "inline-block";

  document.getElementById("question").innerText = questions[current].q;
  correctAnswer = questions[current].a;

  document.getElementById("answer").value = "";

  setTimeout(()=>{
    document.getElementById("answer").focus();
  },50);

  startTime = Date.now();
  current++;
}

function submitAnswer(){

  if(blockSubmit) return;
  blockSubmit = true;

  let answer = Number(document.getElementById("answer").value);
  let endTime = Date.now();
  let time = ((endTime - startTime)/1000).toFixed(2).replace(".", ",");

  fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify({
      question: questions[current-1].q,
      givenAnswer: answer,
      correctAnswer: correctAnswer,
      time: time
    })
  });

  if(current >= questions.length){
    document.getElementById("submitBtn").style.display = "none";
  }

  setTimeout(nextQuestion, 250);
}

function finish(){
  document.getElementById("game").classList.add("hidden");
  document.getElementById("final").classList.remove("hidden");
}

function goMenu(){
  document.getElementById("final").classList.add("hidden");
  document.getElementById("menu").classList.remove("hidden");
}

document.getElementById("answer").addEventListener("keydown", function(e){
  if(e.key === "Enter"){
    submitAnswer();
  }
});

</script>
